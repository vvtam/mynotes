## 安装ansible

subscription-manager repos --enable ansible-2-for-rhel-8-x86_64-rpms

目标主机启用了selinux ，需要安装python3-libselinux或者libselinux-python，才能使用复制，文件，模板功能相关的模块

raw模块直接通过配置远程shell 运行，可用于在目标主机上安装python

raw模块难以通过安全的幂等方式使用，通常运用普通的模块

windows主机需要PowerShell 3.0+，还需要.NET Framework 4.0+

网络设备一般在控制节点上运行网络模块，与网络设备通信通常使用SSH上的cli，SSH上的xml，http(s)上的api

## inventory

嵌套组

```
[usa]
127.0.0.1

[canada]
192.168.223.250

[north_america:children]
usa
canada
```

### 定义变量

一般不要直接在清单中定义变量，最好在特殊目录中定义这些变量

### 动态清单



## 常用命令

ansible 127.0.0.1 --list-hosts  #检查主机是否在列表

ansible ungrouped --list-hosts  #列出未分组的主机

ansible all --become --become-user root --become-method su -m ping -vvvv  #非root用户 su到root

## ansible配置文件

一般使用当前目录下的ansible.cfg文件，然后 ~user/.ansible.cfg，然后 /etc/ansible/ansible.cfg文件

优先使用环境变量 ANSIBLE_CONFIG

确定使用的配置文件

```
[root@vm213 ansible]# ansible --version
ansible 2.9.13
  config file = /root/ansible/ansible.cfg
  configured module search path = ['/root/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3.6/site-packages/ansible
  executable location = /usr/bin/ansible
  python version = 3.6.8 (default, Dec  5 2019, 15:45:45) [GCC 8.3.1 20191121 (Red Hat 8.3.1-5)]
```

### 使用 authorized_key 模块

部署ssh密钥，第一次使用--ask-pass 运行

### sudo su

become = true

become_method = sudo #默认sudo，可以用su

become_user = root #默认root

become_ask_pass = true

添加到/etc/sudoers.d ，sudo不使用密码，或者添加到wheel组？

```
someruser ALL=(ALL)  NOPASSWD:ALL
```

普通用户使用密钥认证，sudo不需要密码示例

```
[defaults]
inventory = ./inventory
remote_user = someuser
ask_pass = false

[privilege_escalation]
become = true
become_method = sudo
become_user = root
become_ask_pass = false
```

### 非ssh连接

默认使用 smart ssh 连接，如果localhost 没有加入到主机列表，则使用local连接类型，直接在本地执行命令

## 临时任务

ansible host -m module -a "1 2 3 4" -i inventory

ansible all --become --become-user root --become-method su -m ping -vvvv

## 模块

文件：copy，file，lineinfile，synchronize

软件包：package，yum，apt，dnf，gem，pip

系统模块：firewalld，reboot，service，user

Net Tools：get_url，nmcli，uri

command模块 不同于shell，还有特殊的raw模块；大多数情况请避免使用这三个模块，如果需要先尝试command模块

## playbook

```
---
- name: Configure important user consistently
  hosts: all
  tasks:
    - name: newbie exists with UID 4000
      user:
        name: newbie
        uid: 4000
        state: present
```

--- ;文档开始标记

... ；文档结束标记，实际应用中省略

同一层，相同缩进量，子项缩进大于父项

`- apple` ; 项目以破折号加空格开头

按顺序执行任务

ansible-playbook --syntax-check checknginx.yml  ;语法验证

ansible-playbook -C checknginx.yml ; 空运行

覆盖其它地方的设置

```
---
- name: Configure important user consistently
  hosts: all
  # 覆盖设置
  reomte_user: xxx
  become: true
  become_method: sudo
  become_user: privileged_user
  tasks:
    - name: newbie exists with UID 4000
      user:
        name: newbie
        uid: 4000
        state: present
```

## ansible-doc

ansible-doc 模块; 生成示例输出

ansible-doc -s 模块 ; 生成示例输出

## 自定义模板

library        = /usr/share/my_modules/

./library

$ANSIBLE_LIBRARY

## 语法

### yaml注释

`# This is a yaml comment`

some data # This is also a yaml comment

### yaml 字符串

通常不需要放引号里，也可以用单引号，双引号

编写多行字符串，用 | 字符表示要保留字符串中的换行字符

```
include_newlines: |
    Example Company
    123 Main street
    Atlanta, GA 20202
```

(>)字符表示换行字符转换成空格字符，提高可读性

```
fold_newlines: >
    This is an example
    of a long string,
    that will becom
    a single sentence once folded.
```

### yaml字典

```
name: svcrole
svcservice: httpd
svcport: 80
```

`{name: svcrole, svcservice: httpd, svcport: 80}` #可读性太差，应避免使用

### yaml列表

```
hosts:
  - servera
  - serverb
  - serverc
```

`hosts: [servera, serverb, serverc]` #可读性太差，应避免使用

### 过时的写法

```
tasks:
  - name: shorthan form
    service: name=httpd enabled=true state=started
```

```
tasks:
  - name: normal form
    service:
      name: httpd
      enabled: true
      state: started
```

## 变量

字母，数字，下划线

全局，主机，play，命令行，都可以定义变量

### play变量

```
---
- name: Configure important user consistently
  hosts: all
  # 定义变量
  vars:
    user: xx
    home: /home/xx
  # 从文件定义
  vars_files:
    - vars/users.yml
  # 覆盖设置
  reomte_user: xxx
  become: true
  become_method: sudo
  become_user: privileged_user
  tasks:
    - name: newbie exists with UID 4000
      user:
        name: newbie # 可以使用 {{ user }} 变量
        uid: 4000
        state: present
```

### 主机变量和组变量

不建议使用

```
[testservers]
192.168.223.250
[testservers:vars]
user=tam
```

```
[usa]
192.168.223.250
[canada]
192.168.223.250
[north_america:children]
usa
canada
[north_america:vars]
user=tam
```

### 使用目录管理主机和组变量

创建 host_vars，group_vars ，下面新建文件存储主机和组的变量，文件名同主机或分组名

### 数组作为变量

```
比如以下参数
user1_first_name: Bob
user1_last_name: Jones
user1_home_dir: /users/bjones
user2_first_name: Anne
user2_last_name: Cook
user2_home_dir: /users/acook
可以改写为：
users:
  bjones:
    first_name: Bob
    last_name: Jones
    home_dir: /users/bjones
  acook:
    first_name: Anne
    last_name: Cook
    home_dir: /users/acook
```

访问变量

```
users.bjones.first_name  # returns 'Bob'
由于变量被定义为python字典，可能会冲突，使用以下语法
users['bjones']['first_name']  # returns 'Bob'
```

### 使用注册变量捕获命令输出



